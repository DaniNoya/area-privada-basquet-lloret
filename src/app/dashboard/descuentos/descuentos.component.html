<div *ngIf="!modal && !assignarPersona" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Descuentos</h1>
</div>

<div *ngIf="!descuentoSeleccionado" [ngClass]="{'mt-3':modal}">
  <mat-form-field>
    <input matInput type="text" placeholder="Filtrar" (keyup)="applyFilter($event.target.value)">
  </mat-form-field>

  <mat-form-field class="ml-5">
    <mat-label>Mètodo de visualización</mat-label>
    <mat-select [(value)]="metodoVisualizacion" (valueChange)="ngOnInit();ngAfterViewInit()">
      <mat-option [value]="'temporadaRegular'">Temporada regular</mat-option>
      <mat-option [value]="'campus'">Campus</mat-option>
      <mat-option [value]="'all'">Todo</mat-option>
    </mat-select>
  </mat-form-field>

  <button *ngIf="!modal && !assignarPersona" (click)="startAdd()" class="btn btn-success float-right">Añadir</button>

  <div class="mat-elevation-z8">
    <mat-spinner [diameter]="50" *ngIf="isLoadingResults"></mat-spinner>
    <table class="w-100" mat-table [dataSource]="dataSource" matSort matSortActive="idTipo" matSortStart="desc">

      <ng-container matColumnDef="concepto">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Concepto </th>
        <td mat-cell *matCellDef="let row"> {{row.concepto}} </td>
      </ng-container>

      <ng-container matColumnDef="dni">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> DNI </th>
        <td mat-cell *matCellDef="let row"> {{row.dni}} </td>
      </ng-container>

      <ng-container matColumnDef="porcentaje">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo Descuento </th>
        <td mat-cell *matCellDef="let row"> {{row.conceptoVisible}} </td>
      </ng-container>

      <ng-container matColumnDef="desAnioPasado">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> D.Año Pasado </th>
        <td mat-cell *matCellDef="let row"> <mat-checkbox color="primary" [checked]="row.desAnioPasado == 1" disabled> </mat-checkbox> </td>
      </ng-container>

      <!-- Acciones sin modal -->
      <ng-container *ngIf="!modal && !assignarPersona" matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="pl-4">Acciones</th>
        <td mat-cell *matCellDef="let row">
          <a mat-icon-button class="btn-table text-warning" (click)="startEdit(row)" tooltip="Editar">
            <mat-icon aria-label="Edit">edit</mat-icon>
          </a>
          <a mat-icon-button class="btn-table text-info" (click)="delete(row)" tooltip="Borrar">
            <mat-icon>delete</mat-icon>
          </a>
        </td>
      </ng-container>

      <!-- Acciones en modal -->
      <ng-container *ngIf="modal" matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let row">
          <a mat-icon-button class="btn-table text-info" (click)="addDirectivoToFamiliar(row)" tooltip="Añadir">
            <mat-icon class="mat-18">add</mat-icon>
          </a>
        </td>
      </ng-container>

      <!-- Acciones en assignarPersona -->
      <ng-container *ngIf="assignarPersona" matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let row">
          <a mat-icon-button class="btn-table text-info" (click)="assigna(row)" tooltip="Añadir">
            <mat-icon class="mat-18">add</mat-icon>
          </a>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;">
      </tr>
    </table>

    <div class="no-results" *ngIf="dataSource.data.length == 0">
      No hay datos
    </div>

    <mat-paginator *ngIf="!modal" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
    <mat-paginator *ngIf="modal" [pageSize]="5"></mat-paginator>
  </div>
</div>

<div *ngIf="descuentoSeleccionado && !crearDescuento">
  <div class="row">
    <div class="col-3">
      <h2>Detalles Descuento</h2>
    </div>
    <div class="col-9 text-right">
      <a (click)="volver()" class="btn btn-secondary text-white">Volver al listado</a>
    </div>
  </div>
  <form #editForm="ngForm" (ngSubmit)="save()">
    <div class="form-row mt-4">
      <div class="col">
        <label for="inputConcepto">Concepto</label>
        <!--<input type="text" class="form-control" id="inputTemporada" name="idTemporada" #inputTemporada="ngModel" [disabled]="!editarDescuento" [(ngModel)]="descuentoSeleccionado.idTemporada" required>
        <div *ngIf="!inputTemporada.valid && (inputTemporada.dirty || inputTemporada.touched)" class="text-danger">Campo requerido</div>-->
        <select class="form-control" id="inputConcepto" name="idTipo" #inputConcepto="ngModel" [disabled]="!editarDescuento" [(ngModel)]="descuentoSeleccionado.idTipo" required>
          <option *ngFor="let TipoPago of conceptoDescuentos" value="{{ TipoPago.id }}">{{ TipoPago.concepto }}</option>
        </select>
        <div *ngIf="!inputConcepto.valid && (inputConcepto.dirty || inputConcepto.touched)" class="text-danger">Campo requerido</div>
      </div>
      <div class="col">
        <label for="inputDni">DNI</label>
        <input type="text" class="form-control" id="inputDni" name="dni" #inputDni="ngModel" [(ngModel)]="descuentoSeleccionado.dni" disabled required>
        <div *ngIf="!inputDni.valid && (inputDni.dirty || inputDni.touched)" class="text-danger">Campo requerido</div>
      </div>
      <div class="col">
        <label for="inputTipoDescuento">Tipo Descuento</label>
        <!--<input type="text" class="form-control" id="inputPorcentaje" name="porcentaje" [disabled]="!editarDescuento" [(ngModel)]="descuentoSeleccionado.porcentaje">-->
        <select class="form-control" id="inputTipoDescuento" name="porcentaje" [disabled]="!editarDescuento" [(ngModel)]="descuentoSeleccionado.porcentaje">
          <option *ngFor="let Importes of tiposDescuentos" value="{{ Importes.importe }}">{{ Importes.conceptoVisible }}</option>
          <!--<option value="15">15%</option>
          <option value="100">100%</option>-->
        </select>
      </div>
      <div class="col">
        <label for="inputDesAnioPasado">D.Año Pasado</label>
        <!--<input type="text" class="form-control" id="inputDesAnioPasado" name="desAnioPasado" [disabled]="!editarDescuento" [(ngModel)]="descuentoSeleccionado.desAnioPasado">-->
        <select class="form-control" id="inputDesAnioPasado" name="desAnioPasado" [disabled]="!editarDescuento" [(ngModel)]="descuentoSeleccionado.desAnioPasado">
          <option value="0">NO</option> 
          <option value="1">SI</option> 
       </select>
      </div>
    </div>
    <br>
    <a *ngIf="!editarDescuento" (click)="editar()" class="btn btn-info">Edición</a>
    <button *ngIf="editarDescuento" [disabled]="!editForm.form.valid" type="submit" class="btn btn-success">Guardar</button>
    <a *ngIf="editarDescuento" (click)="editarDescuento = false" class="btn btn-secondary ml-3">Cancelar</a>
    <div class="btn alert-danger ml-3" *ngIf="error">{{ error }}</div>
  </form>
</div>

<div *ngIf="crearDescuento">
  <div class="row">
    <div class="col-3">
      <h2>Añadir Descuento</h2>
    </div>
    <div class="col-9 text-right">
      <a (click)="volver()" class="btn btn-light">Volver al listado</a>
    </div>
  </div>
  <mat-tab-group mat-stretch-tabs class="mat-elevation-z4">
    <mat-tab label="Nuevo">
      <form #addForm="ngForm" class="p-2" (ngSubmit)="store()">
        <div class="form-row mt-4">
          <div class="col">
            <label for="inputAddConcepto">Concepto</label>
            <!--<input type="text" class="form-control" id="inputAddTemporada" name="idTemporada" #inputAddTemporada="ngModel" [(ngModel)]="descuentoSeleccionado.idTemporada" required>-->
            <select class="form-control" id="inputAddConcepto" name="idTipo" #inputAddConcepto="ngModel" [(ngModel)]="descuentoSeleccionado.idTipo" required>
              <option *ngFor="let TipoPago of conceptoDescuentos" value="{{ TipoPago.id }}">{{ TipoPago.concepto }}</option>
            </select>
            <div *ngIf="!inputAddConcepto.valid && (inputAddConcepto.dirty || inputAddConcepto.touched)" class="text-danger">Campo requerido</div>
          </div>
          <div class="col">
            <label for="inputAddDni">DNI</label>
            <input type="text" class="form-control" id="inputAddDni" name="dni" #inputAddDni="ngModel" [(ngModel)]="descuentoSeleccionado.dni" required>
            <div *ngIf="!inputAddDni.valid && (inputAddDni.dirty || inputAddDni.touched)" class="text-danger">Campo requerido</div>
          </div>
          <div class="col">
            <label for="inputAddTipoDescuento">Tipo Descuento</label>
            <!--<input type="text" class="form-control" id="inputAddPorcentaje" name="porcentaje" #inputAddPorcentaje="ngModel" [(ngModel)]="descuentoSeleccionado.porcentaje" required>-->
            <select class="form-control" id="inputAddTipoDescuento" name="porcentaje" #inputAddTipoDescuento="ngModel" [(ngModel)]="descuentoSeleccionado.porcentaje" required>
              <option *ngFor="let Importes of tiposDescuentos" value="{{ Importes.importe }}">{{ Importes.conceptoVisible }}</option>
              <!--<option value="15">15%</option>
              <option value="100">100%</option>-->
              <div *ngIf="!inputAddTipoDescuento.valid && (inputAddTipoDescuento.dirty || inputAddTipoDescuento.touched)" class="text-danger">Campo requerido</div>
            </select>
          </div>
          <div class="col">
            <label for="inputAddDesAnioPasado">D.Año Pasado</label>
            <!--<input type="text" class="form-control" id="inputAddDesAnioPasado" name="desAnioPasado" #inputAddDesAnioPasado="ngModel" [(ngModel)]="descuentoSeleccionado.desAnioPasado" required>-->
            <select class="form-control" id="inputAddDesAnioPasado" name="desAnioPasado" #inputAddDesAnioPasado="ngModel" [(ngModel)]="descuentoSeleccionado.desAnioPasado" required>
              <option value="0">NO</option>
              <option value="1">SI</option> 
              <div *ngIf="!inputAddDesAnioPasado.valid && (inputAddDesAnioPasado.dirty || inputAddDesAnioPasado.touched)" class="text-danger">Campo requerido</div>
            </select>
          </div>
        </div>
        <br>
        <button [disabled]="!addForm.form.valid" type="submit" class="btn btn-success">Guardar</button>
        <a (click)="volver()" class="btn btn-secondary ml-3">Cancelar</a>
        <div class="btn alert-danger ml-3" *ngIf="error">{{ error }}</div>
      </form>
    </mat-tab>

  </mat-tab-group>
</div>
<ngx-spinner
  bdColor = "rgba(51,51,51,0.8)"
  size = "medium"
  color = "#fff"
  type = "ball-climbing-dot"
  [fullScreen] = "true"
>
  <p style="color: white" > Espere por favor... </p>
</ngx-spinner>
