<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 border-bottom">
  <h1 class="h2">Temporadas</h1>
  <h3>(Temporada actual: <b>{{ temporadaActual }}</b>)</h3>
  <button (click)="addTemporada()" class="btn btn-success">+ Añadir Tempoarada</button>
</div>

<mat-tab-group>
  <mat-tab label="Equipos">
    <div *ngIf="temporadaActual && !asignarJugadores && !asignarEntrenadores && !asignarDelegados" class="container mt-4">
      <div class="row justify-content-between">
        <div class="col-2 text-center">
          <button (click)="addEquipo()" class="btn btn-success btn-sm font-weight-bold">+ Añadir Equipo</button>
        </div>
        <div class="row col-4 justify-content-between">
          <div class="text-center">
            <button (click)="downloadEquipos()" class="btn btn-primary btn-sm font-weight-bold">Descargar Equipos</button>
          </div>
          <div class="text-center">
            <button (click)="downloadPartidos()" class="btn btn-primary btn-sm font-weight-bold">Descargar Partidos</button>
          </div>
        </div>
      </div>
      <div class="row justify-content-center">
        <mat-card class="col-3 m-3" *ngFor="let equipo of equipos">
          <mat-card-header>
            <mat-card-title>{{equipo.categoria}} {{equipo.tipoCategoria}} {{equipo.descripcion}}</mat-card-title>
            <i class="fas fa-globe ml-auto mt-1 {{equipo.activoWeb == true?'text-success':'text-danger'}}" tooltip="{{equipo.activoWeb == true?'Ocultar en la web':'Mostrar en la web'}}" (click)="switchActivoWeb(equipo)"></i>
          </mat-card-header>
          <img mat-card-image src="{{equipo.foto}}" alt="{{equipo.categoria}}">
          <mat-card-content>
            <p>Tipo: <b>{{equipo.tipoCategoria}}</b></p>
            <p>Categoria: <b>{{equipo.categoria}}</b></p>
            <p>Competición: <b>{{equipo.competicion}}</b></p>
            <p>Desde año: <b>{{equipo.nacidos_desde_anyo}}</b> hasta año: <b>{{equipo.nacidos_hasta_anyo}}</b></p>
            <p><i class="fas fa-user"></i> <b> {{equipo.jugadoresTotales}}</b> - <i class="fas fa-user text-success"></i> <b> {{equipo.jugadoresSuccess}}</b> - <i class="fas fa-user text-warning"></i> <b> {{equipo.jugadoresWarning}}</b> - <i class="fas fa-user text-danger"></i> <b> {{equipo.jugadoresDanger}}</b></p>
          </mat-card-content>
          <mat-card-actions>
            <div class="row">
              <button mat-button class="col-5" (click)="verJugadores(equipo)" >Ver Jugadores</button>
              <button mat-button class="col-5" (click)="verEntrenadores(equipo)" >Ver Entrenadores</button>
            </div>
            <div class="row">
              <button mat-button class="col-5" (click)="equipoSeleccionado=equipo;editarDorsales()" >Editar Dorsales</button>
              <button mat-button class="col-5" (click)="verDelegados(equipo)">Ver Delegados</button><i class="fas fa-pen float-right" (click)="editEquipo(equipo)"></i>
            </div>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
    <div *ngIf="temporadaActual && asignarJugadores" class="container mt-4">
      <div class="row justify-content-between">
        <div class="col-4">
          <h5>{{equipoSeleccionado.categoria}} - {{equipoSeleccionado.competicion}}</h5>
        </div>
        <div class="col-6"></div>
        <div class="col-2 text-right">
          <button (click)="volver()" class="btn btn-secondary btn-sm font-weight-bold"><i class="fas fa-arrow-left"></i> Volver</button>
        </div>
      </div>
      <div class="row justify-content-center mt-2">
        <div class="card col p-0 mr-4">
          <div class="card-header">Jugadores Asignados</div>
          <div class="card-body">
            <mat-selection-list class="outline-none" #jugadoresAsignadosSeleccionados>
              <div *ngFor="let jugador of jugadoresAsignados">
                <!--<i class="fas fa-user-edit" (click)="editarJugador(jugador)" tooltip="Editar"></i>-->
                <i class="fas fa-user-edit {{jugador.semaforo}}" (click)="editarJugador(jugador)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="jugador">
                  {{jugador.nombre}} {{jugador.primer_apellido}} {{jugador.segundo_apellido}} - {{jugador.dorsal}}
                </mat-list-option>
              </div>
            </mat-selection-list>
          </div>
        </div>
        <div class="col-2">
          <button (click)="anyadirTodos()" [disabled]="jugadoresDisponibles.length === 0" class="btn btn-outline-success mt-5 w-100 font-weight-bold"><i class="fa fa-angle-double-left"></i> Añadir todos</button>
          <button (click)="anyadirSeleccionados()" [disabled]="jugadoresDisponiblesSeleccionados.selectedOptions.selected.length == 0 && jugadoresDisponiblesJovenesSeleccionados.selectedOptions.selected.length == 0" class="btn btn-outline-success mt-5 w-100 font-weight-bold"><i class="fa fa-angle-double-left"></i> Añadir Seleccionados</button>
          <button (click)="eliminarSeleccionados()" [disabled]="jugadoresAsignados.length === 0 || jugadoresAsignadosSeleccionados.selectedOptions.selected.length == 0" class="btn btn-outline-warning mt-5 w-100 font-weight-bold">Eliminar Seleccionados <i class="fa fa-angle-double-right"></i></button>
          <button (click)="eliminarTodos()" [disabled]="jugadoresAsignados.length === 0" class="btn btn-outline-danger mt-5 w-100 font-weight-bold">Eliminar todos <i class="fa fa-angle-double-right"></i></button>
          <button (click)="editarDorsales()" class="btn btn-outline-info mt-5 w-100 font-weight-bold">Editar dorsales <i class="fas fa-sort-numeric-up"></i></button>
        </div>
        <div class="card col p-0 ml-4">
          <div class="card-header">Jugadores Disponibles</div>
          <div class="card-body">
            <input type="text" class="form-control mb-3" placeholder="Filtro" #jugadoresDisponiblesFilter (keyup)="verJugadores(equipoSeleccionado, $event.target.value)"/>
            <h5>Jugadores {{equipoSeleccionado.tipoCategoria}} - Entre {{equipoSeleccionado.nacidos_desde_anyo}} y {{equipoSeleccionado.nacidos_hasta_anyo}}</h5>
            <mat-selection-list class="outline-none" #jugadoresDisponiblesSeleccionados>
              <div *ngFor="let jugador of jugadoresDisponibles">
                <i class="fas fa-user-edit {{jugador.semaforo}}" (click)="editarJugador(jugador)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="jugador">
                  {{jugador.nombre}} {{jugador.primer_apellido}} {{jugador.segundo_apellido}}
                </mat-list-option>
              </div>
            </mat-selection-list>
            <hr class="w-100" style="border:1px dashed"/>
            <h5>Otros jugadores disponibles</h5>
            <mat-selection-list class="outline-none" #jugadoresDisponiblesJovenesSeleccionados>
              <div *ngFor="let jugador of jugadoresDisponiblesJovenes">
                <i class="fas fa-user-edit {{jugador.semaforo}}" (click)="editarJugador(jugador)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="jugador">
                  {{jugador.nombre}} {{jugador.primer_apellido}} {{jugador.segundo_apellido}}
                </mat-list-option>
              </div>
            </mat-selection-list>
          </div>
        </div>
      </div>
    </div>
    
    <div *ngIf="temporadaActual && asignarEntrenadores" class="container mt-4">
      <div class="row justify-content-between">
        <div class="col-4">
          <h5>{{equipoSeleccionado.categoria}} - {{equipoSeleccionado.competicion}}</h5>
        </div>
        <div class="col-6"></div>
        <div class="col-2 text-right">
          <button (click)="volver()" class="btn btn-secondary btn-sm font-weight-bold"><i class="fas fa-arrow-left"></i> Volver</button>
        </div>
      </div>
      <div class="row justify-content-center mt-2">
        <div class="card col p-0 mr-4">
          <div class="card-header">Entrenadores Asignados</div>
          <div class="card-body">
            <mat-selection-list class="outline-none" #entrenadoresAsignadosSeleccionados>
              <div *ngFor="let entrenador of entrenadoresAsignados">
                <h6>{{entrenador.tipo_entrenador}}</h6>
                <i class="fas fa-user-edit" (click)="editarEntrenador(entrenador)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="entrenador">
                  {{entrenador.nombre}} {{entrenador.primer_apellido}} {{entrenador.segundo_apellido}}<br/>
                  Formación: {{entrenador.nivel_formacion}}
                </mat-list-option>
              </div>
            </mat-selection-list>
          </div>
        </div>
        <div class="col-2">
          <button (click)="anyadirEntrenador(1)" [disabled]="primerEntradorCount === 1" class="btn btn-outline-success mt-5 w-100 font-weight-bold"><i class="fa fa-angle-double-left"></i> Añadir Primer Entrenador</button>
          <button (click)="anyadirEntrenador(2)" [disabled]="segundoEntrenadorCount === 3" class="btn btn-outline-success mt-5 w-100 font-weight-bold"><i class="fa fa-angle-double-left"></i> Añadir Segundo Entrenador</button>
         <!-- <button (click)="anyadirEntrenador(3)" [disabled]="delegadosCount === 3" class="btn btn-outline-success mt-5 w-100 font-weight-bold"><i class="fa fa-angle-double-left"></i> Añadir Delegado de equipo</button>-->
          <button (click)="eliminarEntrenadoresSeleccionados()" [disabled]="entrenadoresAsignados.length === 0 || entrenadoresAsignadosSeleccionados.selectedOptions.selected.length == 0" class="btn btn-outline-warning mt-5 w-100 font-weight-bold"> Eliminar Seleccionados <i class="fa fa-angle-double-right"></i></button>
          <button (click)="eliminarTodosEntrenadores()" [disabled]="entrenadoresAsignados.length === 0" class="btn btn-outline-danger mt-5 w-100 font-weight-bold"> Eliminar todos <i class="fa fa-angle-double-right"></i></button>
        </div>
        <div class="card col p-0 ml-4">
          <div class="card-header">Entrenadores Disponibles</div>
          <div class="card-body">
            <input type="text" class="form-control mb-3" placeholder="Filtro" #entrenadoresDisponiblesFilter (keyup)="verEntrenadores(equipoSeleccionado, $event.target.value)"/>
            <mat-selection-list class="outline-none" #entrenadoresDisponiblesSeleccionados>
              <div *ngFor="let entrenador of entrenadoresDisponibles">
                <i class="fas fa-user-edit" (click)="editarEntrenador(entrenador)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="entrenador">
                  {{entrenador.nombre}} {{entrenador.primer_apellido}} {{entrenador.segundo_apellido}}<br/>
                  Formación: {{entrenador.nivel_formacion}}
                </mat-list-option>
              </div>
            </mat-selection-list>
          </div>
        </div>
      </div>
    </div>
    
    <div *ngIf="temporadaActual && asignarDelegados" class="container mt-4">
      <div class="row justify-content-between">
        <div class="col-4">
          <h5>{{equipoSeleccionado.categoria}} - {{equipoSeleccionado.competicion}}</h5>
        </div>
        <div class="col-6"></div>
        <div class="col-2 text-right">
          <button (click)="volver()" class="btn btn-secondary btn-sm font-weight-bold"><i class="fas fa-arrow-left"></i> Volver</button>
        </div>
      </div>
      <div class="row justify-content-center mt-2">
        <div class="card col p-0 mr-4">
          <div class="card-header">Delegados Asignados</div>
          <div class="card-body">
            <mat-selection-list class="outline-none" #directivosAsignadosSeleccionados>
              <h5 *ngIf="directivosAsignados.length > 0">Directivos Asignados</h5>
              <div *ngFor="let directivo of directivosAsignados">
                <i class="fas fa-user-edit" (click)="editarDirectivo(directivo)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="directivo">
                  {{directivo.nombre}} {{directivo.primer_apellido}} {{directivo.segundo_apellido}}<br/>
                </mat-list-option>
              </div>
            </mat-selection-list>
            <mat-selection-list class="outline-none" #familiaresAsignadosSeleccionados>
              <h5 *ngIf="familiaresAsignados.length > 0">Familiares Asignados</h5>
              <div *ngFor="let familiar of familiaresAsignados">
                <i class="fas fa-user-edit" (click)="editarFamiliar(familiar)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="familiar">
                  {{familiar.nombre}} {{familiar.primer_apellido}} {{familiar.segundo_apellido}}<br/>
                </mat-list-option>
              </div>
            </mat-selection-list>
          </div>
        </div>
        <div class="col-2">
          <button (click)="anyadirDelegado()" [disabled]="delegadosCount === 3" class="btn btn-outline-success mt-5 w-100 font-weight-bold"><i class="fa fa-angle-double-left"></i> Añadir Delegado(s) de equipo</button>
          <button (click)="eliminarDelegadosSeleccionados()" [disabled]="(directivosAsignados.length + familiaresAsignados.length === 0) || (directivosAsignadosSeleccionados.selectedOptions.selected.length + familiaresAsignadosSeleccionados.selectedOptions.selected.length == 0)" class="btn btn-outline-warning mt-5 w-100 font-weight-bold"> Eliminar Seleccionados <i class="fa fa-angle-double-right"></i></button>
          <button (click)="eliminarTodosDelegados()" [disabled]="(directivosAsignados.length + familiaresAsignados.length === 0)" class="btn btn-outline-danger mt-5 w-100 font-weight-bold"> Eliminar todos <i class="fa fa-angle-double-right"></i></button>
        </div>
        <div class="card col p-0 ml-4">
          <div class="card-header">Delegados Disponibles</div>
          <div class="card-body">
            <input type="text" class="form-control mb-3" placeholder="Filtro" #delegadosDisponiblesFilter (keyup)="verDelegados(equipoSeleccionado, $event.target.value)"/>
            <mat-selection-list class="outline-none" #directivosDisponiblesSeleccionados>
              <h5>Directivos disponibles</h5>
              <div *ngFor="let directivo of directivosDisponibles">
                <i class="fas fa-user-edit" (click)="editarDirectivo(directivo)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="directivo">
                  {{directivo.nombre}} {{directivo.primer_apellido}} {{directivo.segundo_apellido}}<br/>
                </mat-list-option>
              </div>
            </mat-selection-list>
            <mat-selection-list class="outline-none" #familiaresDisponiblesSeleccionados>
              <h5>Familiares disponibles</h5>
              <div *ngFor="let familiar of familiaresDisponibles">
                <i class="fas fa-user-edit" (click)="editarFamiliar(familiar)" tooltip="Editar"></i>
                <mat-list-option class="w-75 d-inline-block" [value]="familiar">
                  {{familiar.nombre}} {{familiar.primer_apellido}} {{familiar.segundo_apellido}}<br/>
                </mat-list-option>
              </div>
            </mat-selection-list>
          </div>
        </div>
      </div>
    </div>
  </mat-tab>

  <mat-tab label="Precios">
    <div *ngIf="!importeSeleccionado" class="p-2 mt-2">

      <mat-form-field>
        <mat-label>Mètodo de visualización</mat-label>
        <mat-select [(value)]="metodoVisualizacion" (valueChange)="ngOnInit();ngAfterViewInit()">
          <mat-option [value]="'all'">Todo</mat-option>
          <mat-option [value]="'descuento'">Descuento</mat-option>
          <mat-option [value]="'porcentaje'">Porcentaje</mat-option>
        </mat-select>
      </mat-form-field>

      <button (click)="startImporteAdd()" class="btn btn-success float-right" hidden>Añadir</button>

      <div class="mat-elevation-z8">
        <mat-spinner [diameter]="50" *ngIf="isLoadingResults"></mat-spinner>
        <table class="w-100" mat-table [dataSource]="dataSource" matSort matSortActive="idTemporada" matSortStart="desc">
    
          <ng-container matColumnDef="conceptoVisible">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Concepto </th>
            <td mat-cell *matCellDef="let row"> {{row.conceptoVisible}} </td>
          </ng-container>

          <ng-container matColumnDef="importe">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Importe </th>
            <td mat-cell *matCellDef="let row"> {{row.importe}} </td>
          </ng-container>

          <ng-container matColumnDef="esDescuento">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Descuento </th>
            <td mat-cell *matCellDef="let row"> <mat-checkbox color="primary" [checked]="row.esDescuento == 1" disabled> </mat-checkbox> </td>
          </ng-container>

          <ng-container matColumnDef="esPorcentaje">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Porcentaje </th>
            <td mat-cell *matCellDef="let row"> <mat-checkbox color="primary" [checked]="row.esPorcentaje == 1" disabled> </mat-checkbox> </td>
          </ng-container>
    
          <!-- Acciones sin modal -->
          <ng-container *ngIf="!modal && !assignarPersona" matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="pl-4">Acciones</th>
            <td mat-cell *matCellDef="let row">
              <a mat-icon-button class="btn-table text-warning" (click)="startEdit(row)" tooltip="Editar">
                <mat-icon aria-label="Edit">edit</mat-icon>
              </a>
              <a mat-icon-button class="btn-table text-info" (click)="delete(row)" tooltip="Borrar">
                <mat-icon>delete</mat-icon>
              </a>
            </td>
          </ng-container>
    
          <!-- Acciones en modal -->
          <ng-container *ngIf="modal" matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let row">
              <a mat-icon-button class="btn-table text-info" (click)="addDirectivoToFamiliar(row)" tooltip="Añadir">
                <mat-icon class="mat-18">add</mat-icon>
              </a>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;">
          </tr>
        </table>
    
        <div class="no-results" *ngIf="dataSource.data.length == 0">
          No hay datos
        </div>
    
        <mat-paginator *ngIf="!modal" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
        <mat-paginator *ngIf="modal" [pageSize]="5"></mat-paginator>
      </div>
    </div>

    <div *ngIf="importeSeleccionado && !crearImporte">
      <div class="row">
        <div class="col-3">
          <h2>Detalles Importe</h2>
        </div>
        <div class="col-9 text-right">
          <a (click)="volverImportes()" class="btn btn-secondary text-white">Volver al listado</a>
        </div>
      </div>
      <form #editForm="ngForm" (ngSubmit)="saveImporte()">
        <div class="form-row mt-4">
          <div class="col">
            <label for="inputConcepto">Concepto</label>
            <input class="form-control" id="inputConcepto" name="concepto" #inputConcepto="ngModel" [(ngModel)]="importeSeleccionado.conceptoVisible" disabled required>
            <div *ngIf="!inputConcepto.valid && (inputConcepto.dirty || inputConcepto.touched)" class="text-danger">Campo requerido</div>
          </div>
          <div class="col">
            <label for="inputImporte">Importe</label>
            <input type="text" class="form-control" id="inputImporte" name="importe" #inputImporte="ngModel" [disabled]="!editarImporte" [(ngModel)]="importeSeleccionado.importe" required>
            <div *ngIf="!inputImporte.valid && (inputImporte.dirty || inputImporte.touched)" class="text-danger">Campo requerido</div>
          </div>
          <div class="col">
            <label for="inputEsDescuento">Descuento</label>
            <select class="form-control" id="inputEsDescuento" name="esDescuento" [disabled]="!editarImporte" [(ngModel)]="importeSeleccionado.esDescuento">
              <option value="0">NO</option> 
              <option value="1">SI</option> 
           </select>
          </div>
          <div class="col">
            <label for="inputEsPorcentaje">Porcentaje</label>
            <select class="form-control" id="inputEsPorcentaje" name="esPorcentaje" [disabled]="!editarImporte" [(ngModel)]="importeSeleccionado.esPorcentaje">
              <option value="0">NO</option> 
              <option value="1">SI</option> 
           </select>
          </div>
        </div>
        <br>
        <a *ngIf="!editarImporte" (click)="editar()" class="btn btn-info">Edición</a>
        <button *ngIf="editarImporte" [disabled]="!editForm.form.valid" type="submit" class="btn btn-success">Guardar</button>
        <a *ngIf="editarImporte" (click)="editarImporte = false" class="btn btn-secondary ml-3">Cancelar</a>
        <div class="btn alert-danger ml-3" *ngIf="error">{{ error }}</div>
      </form>
    </div>

    <div *ngIf="crearImporte">
      <div class="row">
        <div class="col-3">
          <h2>Añadir Importe</h2>
        </div>
        <div class="col-9 text-right">
          <a (click)="volverImportes()" class="btn btn-light">Volver al listado</a>
        </div>
      </div>
      <mat-tab-group mat-stretch-tabs class="mat-elevation-z4">
        <mat-tab label="Nuevo">
          <form #addForm="ngForm" class="p-2" (ngSubmit)="storeImporte()">
            <div class="form-row mt-4">
              <div class="col">
                <label for="inputAddTipoImporte">Concepto</label>
                <select class="form-control" id="inputAddTipoImporte" name="conceptoVisible" #inputAddTipoImporte="ngModel" [(ngModel)]="importeSeleccionado.conceptoVisible" required>
                  <option *ngFor="let Importes of tiposDescuentos" value="{{ Importes.id }}">{{ Importes.conceptoVisible }}</option>
                  <div *ngIf="!inputAddTipoImporte.valid && (inputAddTipoImporte.dirty || inputAddTipoImporte.touched)" class="text-danger">Campo requerido</div>
                </select>
              </div>
              <div class="col">
                <label for="inputAddImporte">Importe</label>
                <input type="text" class="form-control" id="inputAddImporte" name="importe" #inputAddImporte="ngModel" [(ngModel)]="importeSeleccionado.importe" required>
                <div *ngIf="!inputAddImporte.valid && (inputAddImporte.dirty || inputAddImporte.touched)" class="text-danger">Campo requerido</div>
              </div>
              <div class="col">
                <label for="inputAddEsDescuento">Descuento</label>
                <select class="form-control" id="inputAddEsDescuento" name="esDescuento" [(ngModel)]="importeSeleccionado.esDescuento">
                  <option value="0">NO</option> 
                  <option value="1">SI</option> 
               </select>
              </div>
              <div class="col">
                <label for="inputAddEsPorcentaje">Porcentaje</label>
                <select class="form-control" id="inputAddEsPorcentaje" name="esPorcentaje" [(ngModel)]="importeSeleccionado.esPorcentaje">
                  <option value="0">NO</option> 
                  <option value="1">SI</option> 
               </select>
              </div>
            </div>
            <br>
            <button [disabled]="!addForm.form.valid" type="submit" class="btn btn-success">Guardar</button>
            <a (click)="volverImportes()" class="btn btn-secondary ml-3">Cancelar</a>
            <div class="btn alert-danger ml-3" *ngIf="error">{{ error }}</div>
          </form>
        </mat-tab>
      </mat-tab-group>
    </div>

  </mat-tab>
</mat-tab-group>
<ngx-spinner
  bdColor = "rgba(51,51,51,0.8)"
  size = "medium"
  color = "#fff"
  type = "ball-climbing-dot"
  [fullScreen] = "true"
>
  <p style="color: white" > Espere por favor... </p>
</ngx-spinner>
